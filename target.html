<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åœ–åƒæ•æ‰éŠæˆ²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
 @import url('https://fonts?family=Nunito:wght@600;700;800&display=swap'); 

@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@600;700;800&display=swap');
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* æ ¸å¿ƒä½ˆå±€: Flexboxï¼Œé–å®šè¦–çª—é«˜åº¦ï¼Œå‚ç›´åˆ†é…ç©ºé–“ */
        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #1e3a8a, #0c4a6e);
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            overflow: hidden; /* é˜²æ­¢æ•´å€‹é é¢æ»¾å‹• */
        }

        /* éš±è—çš„ç›®æ¨™ DIVï¼Œä¸æ‡‰å½±éŸ¿ä½ˆå±€å’Œé»æ“Š */
        #targetDiv {
            display: none !important;
            position: absolute;
            z-index: -1;
        }
        
        /* ç›®æ¨™é¡¯ç¤ºå€ */
        #displayer {
            position: relative;
            z-index: 800;
            text-align: center;
            padding: 0.5rem 1rem;
            margin-bottom: 0.5rem;
            width: 100%;
            max-width: 1200px;
            background: #1f2937;
            border-radius: 0.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        /* å·¥å…·åˆ— (Toolbar) - ç¢ºä¿é«˜å †ç–Šå±¤ç´šå’Œä¸è¢«æ“ å£“ */
        .p-4.bg-white.rounded-xl {
            position: relative;
            z-index: 900;
            flex-shrink: 0;
            margin-bottom: 1rem;
            max-width: 1200px;
            /* é™åˆ¶æœ€å¤§é«˜åº¦ä¸¦å…è¨±å…§éƒ¨æ»¾å‹•ï¼Œé˜²æ­¢æ¨æ“ ç·¨è¼¯å™¨ */
            max-height: 40vh; 
            overflow-y: auto; 
        }

        /* ç·¨è¼¯å™¨å€åŸŸ - ä½”ç”¨æ‰€æœ‰å‰©é¤˜ç©ºé–“ */
        #editor {
            flex-grow: 1;
            width: 100%;
            max-width: 1200px;
            min-height: 0; /* å…è¨± Flexbox å£“ç¸® */
            
            position: relative;
            z-index: 10;
            
            background: linear-gradient(to top right, #e0f2f1, #b2dfdb);
            border-radius: 1rem;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            transition: opacity 0.3s;
            cursor: none; 
        }

        /* éŠæˆ²å…§å®¹å­å®¹å™¨ */
        #game-content-container {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }

        /* å¯æ‹–æ›³åœ–åƒï¼ˆç§»å‹•ç›®æ¨™ï¼‰ */
        .draggable-image {
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #fca5a5;
            background-size: cover;
            background-position: center;
            cursor: default;
            border: 4px solid white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: border-color 0.1s, transform 0.1s, opacity 0.1s, background-color 0.1s; /* æ·»åŠ èƒŒæ™¯è‰²éæ¸¡ */
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #7f1d1d;
            user-select: none;
            z-index: 20;
        }

        /* éŠæ¨™ç©å®¶ (ç”±æ»‘é¼ æˆ–è§¸æ§æ§åˆ¶) */
        #cursor-player {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #38bdf8, #22d3ee);
            border: 4px solid #164e63;
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.8), 0 0 5px rgba(0, 0, 0, 0.5);
            pointer-events: none;
            z-index: 30;
            transition: background-color 0.1s;
        }
    </style>

    <script>
        // æ ¸å¿ƒç‹€æ…‹å®šç¾©
        window.DRAG_SPEED = 1.5;
        window.isAnimationRunning = false;
        window.score = 0;
        window.currentTargetId = null;
        window.currentAnimationType = 'flow-left';
        window.draggableStates = new Map();
        window.animationFrameId = null;
        window.timerId = null;
// âœ¨ æ–°å¢çš„é–å®šç‹€æ…‹è®Šæ•¸
window.isSelectingNewTarget = false; // <--- è«‹ç¢ºä¿æ·»åŠ é€™ä¸€è¡Œ
        // å…ƒç´ å¼•ç”¨
        window.speedSlider = null;
        window.currentSpeedDisplay = null;
        window.scoreDisplay = null;
        window.cursorPlayer = null;
        window.editor = null;
        window.gameContentContainer = null;

/**
 * è™•ç†ç›®æ¨™ç‰©é«”çš„é–ƒçˆè¦–è¦ºæ•ˆæœ (å¼•å…¥ Hit ç‹€æ…‹é–å®š)
 * @param {HTMLElement} element - ç›®æ¨™å…ƒç´ 
 * @param {string} flashColor - é–ƒçˆé¡è‰²
 * @param {boolean} isCorrectHit - æ˜¯å¦ç‚ºæ­£ç¢ºæ•æ‰
 */
function flashTarget(element, flashColor, isCorrectHit) {
    if (!element) return;
    
    // è¨­ç½®é–å®šç‹€æ…‹ï¼Œé˜²æ­¢ç«‹å³å†æ¬¡è§¸ç™¼ç¢°æ’
    element.isHit = true; 
    
    const originalBorderColor = 'white'; 
    const originalBorderWidth = '4px'; 
    
    // æ­¥é©Ÿ 1: è®Šç‚ºé–ƒçˆè‰²å’Œå¯¬åº¦
    element.style.borderColor = flashColor;
    element.style.borderWidth = '6px'; 
    
    // æ­¥é©Ÿ 2: å»¶é²å¾Œæ¢å¾©åŸä¾†çš„é‚Šæ¡†ä¸¦è§£é–
    setTimeout(() => {
        element.style.borderColor = originalBorderColor;
        element.style.borderWidth = originalBorderWidth;
        
        // åªæœ‰ç•¶å…ƒç´ ä¸æ˜¯ç•¶å‰ç›®æ¨™æ™‚ï¼Œæ‰è§£é– (å¦‚æœå®ƒæ˜¯æ­£ç¢ºç›®æ¨™ï¼Œå®ƒæœƒåœ¨ selectNewTarget ä¸­è¢«ç§»é™¤ï¼Œä½†å®‰å…¨èµ·è¦‹ï¼Œæˆ‘å€‘åœ¨é€™è£¡è§£é–)
        element.isHit = false; 
    }, 100); 
}


/**
 * å°‡å–®å€‹ç›®æ¨™ç‰©é«”ç¬ç§»åˆ°æ–°çš„å®‰å…¨éš¨æ©Ÿä½ç½® (å·²ä¿®æ­£: å¼•å…¥å®‰å…¨åç§»é‡)
 * @param {HTMLElement} item - è¦ç§»å‹•çš„ç›®æ¨™å…ƒç´ 
 */
function teleportTargetToNewPosition(item) {
    if (!window.editor || !item) return;

    const editorWidth = window.editor.offsetWidth;
    const editorHeight = window.editor.offsetHeight;
    
    const w = item.offsetWidth;
    const h = item.offsetHeight;
    
    const PADDING = 10;
    const SAFE_OFFSET = 150; // <<< é—œéµä¿®æ­£: æœ€å°åç§»é‡ (150px)

    const maxX = editorWidth - w - PADDING;
    const maxY = editorHeight - h - PADDING;
    
    // 1. ç”Ÿæˆ X è»¸éš¨æ©Ÿä½ç½®
    let randomX = Math.random() * (maxX - PADDING) + PADDING;

    // 2. ç”Ÿæˆ Y è»¸éš¨æ©Ÿä½ç½®
    let randomY = Math.random() * (maxY - PADDING) + PADDING;
    
    
    // --- æ‡‰ç”¨å®‰å…¨åç§» (æ ¸å¿ƒé‚è¼¯) ---
    
    // ç¢ºä¿ X è»¸ä½ç½®ä¸åœ¨ä¸­å¤®æ¸¸æ¨™é™„è¿‘ (ä¾‹å¦‚: åœ¨æ°´å¹³æ¨¡å¼ä¸‹æ¸¸æ¨™è¢«é–å®šåœ¨ä¸­å¤® X è»¸)
    const centerX = editorWidth / 2;
    if (Math.abs(randomX - centerX) < SAFE_OFFSET) {
        // å¦‚æœå¤ªé è¿‘ä¸­å¤®ï¼Œå¼·åˆ¶å®ƒç§»åˆ°å·¦é‚Šæˆ–å³é‚Šçš„å®‰å…¨å€
        if (randomX < centerX) {
            randomX = Math.max(PADDING, randomX - SAFE_OFFSET); // ç§»åˆ°å·¦é‚Š
        } else {
            randomX = Math.min(maxX, randomX + SAFE_OFFSET); // ç§»åˆ°å³é‚Š
        }
    }

    // ç¢ºä¿ Y è»¸ä½ç½®ä¸åœ¨ä¸­å¤®æ¸¸æ¨™é™„è¿‘ (ä¾‹å¦‚: åœ¨å‚ç›´æ¨¡å¼ä¸‹æ¸¸æ¨™è¢«é–å®šåœ¨ä¸­å¤® Y è»¸)
    const centerY = editorHeight / 2;
    if (Math.abs(randomY - centerY) < SAFE_OFFSET) {
         // å¦‚æœå¤ªé è¿‘ä¸­å¤®ï¼Œå¼·åˆ¶å®ƒç§»åˆ°ä¸Šé‚Šæˆ–ä¸‹é‚Šçš„å®‰å…¨å€
        if (randomY < centerY) {
            randomY = Math.max(PADDING, randomY - SAFE_OFFSET); // ç§»åˆ°ä¸Šé‚Š
        } else {
            randomY = Math.min(maxY, randomY + SAFE_OFFSET); // ç§»åˆ°ä¸‹é‚Š
        }
    }
    // ------------------------------------
    
    // åŸ·è¡Œç¬ç§»
    item.style.left = `${randomX}px`;
    item.style.top = `${randomY}px`;
    
    // é‡è¨­è©²ç›®æ¨™çš„é€Ÿåº¦ç‹€æ…‹
    window.draggableStates.delete(item);
    window.resetDraggablePosition(item, window.currentAnimationType);
}





        /**
         * åŸ·è¡Œå¾ localStorage è¼‰å…¥çš„å…§å®¹æ³¨å…¥å’ŒéŠæˆ²ç‹€æ…‹é‡ç½®
         */
        function updateStage() {
            const content = document.getElementById('targetDiv').innerHTML;
            if (window.gameContentContainer) {
                 window.gameContentContainer.innerHTML = content;
            }
            window.rebindElementsAndState();
            window.setSafeInitialPositions();
            window.selectNewTarget();

            if (window.isAnimationRunning) {
                window.animateAllRandomly(window.currentAnimationType);
            }
        }

        /**
         * é‡æ–°ç²å–æ‰€æœ‰ DOM å…ƒç´ å¼•ç”¨
         */
        window.rebindElementsAndState = function() {
            window.speedSlider = document.getElementById('speedSlider');
            window.currentSpeedDisplay = document.getElementById('currentSpeedDisplay');
            window.scoreDisplay = document.getElementById('scoreDisplay');
            window.cursorPlayer = document.getElementById('cursor-player');
            window.editor = document.getElementById('editor');
            window.gameContentContainer = document.getElementById('game-content-container');

            if (window.speedSlider && !window.speedSlider._listenerAdded) {
                window.speedSlider.addEventListener('input', (e) => {
                    window.DRAG_SPEED = parseFloat(e.target.value);
                    window.currentSpeedDisplay.textContent = window.DRAG_SPEED.toFixed(2);
                });
                window.speedSlider._listenerAdded = true;
            }
            
            if (!window.cursorPlayer) {
                window.cursorPlayer = document.getElementById('cursor-player');
            }

            window.DRAG_SPEED = parseFloat(window.speedSlider ? window.speedSlider.value : 1.5);
        }

        // --- Helper: ç²å–å…ƒç´ é‚Šç•Œä¿¡æ¯ ---
        function getRect(el) {
            if (!el) return { x: 0, y: 0, w: 0, h: 0 };
            return {
                x: el.offsetLeft,
                y: el.offsetTop,
                w: el.offsetWidth,
                h: el.offsetHeight
            };
        }

        // --- éŠæˆ²é‚è¼¯: é¸æ“‡æ–°ç›®æ¨™ (é¡¯ç¤º IDï¼Œç„¡é«˜äº®) ---
        window.selectNewTarget = function(previousTarget = null) {
            if (!window.gameContentContainer) return;
            const targets = Array.from(window.gameContentContainer.querySelectorAll('.draggable-image'));
            const currentTargetEl = previousTarget || document.getElementById(window.currentTargetId);

            // æ¸…é™¤èˆŠç›®æ¨™çš„é‚Šæ¡† (å¦‚æœé‚„æœ‰æ®˜ç•™)
            if (currentTargetEl) {
                currentTargetEl.style.border = '4px solid white';
            }

            const availableTargets = targets.filter(item => item.id !== previousTarget?.id);

            const displayer = document.getElementById('displayer');

            if (availableTargets.length > 0) {
                const randomIndex = Math.floor(Math.random() * availableTargets.length);
                const newTarget = availableTargets[randomIndex];
                window.currentTargetId = newTarget.id;

                if (displayer) {
                    displayer.innerHTML = `<span style="color: #60a5fa; font-size: 24px; font-weight: bold;">ç›®æ¨™: ${newTarget.id}</span>`;
                }
                
                newTarget.style.border = '4px solid white';
                
            } else {
                window.currentTargetId = null;
                if (displayer) {
                    displayer.innerHTML = `<span style="color: #6ee7b7; font-size: 20px;">ç„¡å¯ç”¨ç›®æ¨™!</span>`;
                }
            }
        }


// --- éŠæˆ²é‚è¼¯: ç¢°æ’æª¢æ¸¬ã€è¨ˆåˆ†èˆ‡æ‡²ç½° (æœ€çµ‚ç©©å®šç‰ˆ - ç©ºé–“è§£æ±ºæ–¹æ¡ˆ) ---
function checkCollisionAndScore() {
    if (!window.isAnimationRunning || !window.cursorPlayer || !window.gameContentContainer) return;

    const playerRect = getRect(window.cursorPlayer);
    const targets = window.gameContentContainer.querySelectorAll('.draggable-image');
    
    let correctTargetHit = null; 
    let wrongTargetHit = null;  

    // éšæ®µ 1: æ‰¾å‡ºæ‰€æœ‰ç¢°æ’ç›®æ¨™
    targets.forEach(targetEl => {
        // ğŸš¨ é€™è£¡ä¸å†éœ€è¦æª¢æŸ¥ isHit ç‹€æ…‹
        // if (targetEl.isHit) { return; } 

        const targetRect = getRect(targetEl);
        
        const collision = (
            playerRect.x < targetRect.x + targetRect.w &&
            playerRect.x + playerRect.w > targetRect.x &&
            playerRect.y < targetRect.y + targetRect.h &&
            playerRect.y + playerRect.h > targetRect.y 
        );

        if (collision) {
            if (targetEl.id === window.currentTargetId) {
                correctTargetHit = targetEl; 
            } else {
                wrongTargetHit = targetEl;  
            }
        }
    });

    // --- éšæ®µ 2: è™•ç†æ­£ç¢ºæ•æ‰ (æœ€é«˜å„ªå…ˆç´š) ---
    if (correctTargetHit) {
        
        // ğŸ’ ç¢°æ’åˆ°æ­£ç¢ºç›®æ¨™ï¼šåŠ åˆ†
        window.score++;
        if (window.scoreDisplay) window.scoreDisplay.textContent = window.score;
        
        // 1. åŸ·è¡Œç¬ç§»ï¼Œå°‡ç›®æ¨™ç§»å‡ºæ¸¸æ¨™å€åŸŸ
        teleportTargetToNewPosition(correctTargetHit); 

        // 2. è¦–è¦ºå›é¥‹ (æˆåŠŸ)
        flashTarget(correctTargetHit, '#10b981', true); 

        // 3. ç©å®¶è¦–è¦ºå›é¥‹ 
        window.cursorPlayer.style.backgroundColor = '#6ee7b7'; 
        setTimeout(window.restorePlayerColor, 100);

        // 4. é¸æ“‡ä¸‹ä¸€å€‹æ–°ç›®æ¨™ (å‚³éèˆŠç›®æ¨™ï¼Œç¢ºä¿ä¸é¸åˆ°è‡ªå·±)
        window.selectNewTarget(correctTargetHit);
        
        // *** é—œéµ: ç«‹å³è¿”å›ï¼Œé˜²æ­¢åŒä¸€å¹€æ‡²ç½° ***
        return; 
    }

    // --- éšæ®µ 3: è™•ç†éŒ¯èª¤æ•æ‰ (æ¬¡è¦å„ªå…ˆç´š) ---
    if (wrongTargetHit) {
        // âŒ ç¢°æ’åˆ°éŒ¯èª¤ç›®æ¨™ï¼šæ‰£åˆ†
        if (window.score > 0) {
            window.score--; 
        }
        if (window.scoreDisplay) window.scoreDisplay.textContent = window.score;

        // è¦–è¦ºå›é¥‹ (éŒ¯èª¤)
        flashTarget(wrongTargetHit, '#ef4444', false); 

        // ç©å®¶è¦–è¦ºå›é¥‹ 
        window.cursorPlayer.style.backgroundColor = '#ef4444'; 
        setTimeout(window.restorePlayerColor, 100);
    }
}
        
        /**
         * æ ¹æ“šç•¶å‰æ¨¡å¼æ¢å¾©ç©å®¶æ¸¸æ¨™çš„é¡è‰²
         */
        window.restorePlayerColor = function() {
            if (['fall-down', 'vertical'].includes(window.currentAnimationType)) {
                 window.cursorPlayer.style.backgroundColor = '#9333ea';
             } else if (['flow-left', 'horizontal'].includes(window.currentAnimationType)) {
                 window.cursorPlayer.style.backgroundColor = '#f59e0b';
             } else {
                 window.cursorPlayer.style.backgroundColor = '#38bdf8';
             }
        }

// --- Helper: è¨­ç½®å…ƒç´ åˆå§‹ä½ç½® (å·²ä¿®æ­£: é‡æ–°å®šç¾© editorWidth/editorHeight) ---
window.setSafeInitialPositions = function() {
    if (!window.editor || !window.gameContentContainer) return;

    // ğŸš¨ é—œéµä¿®æ­£ï¼šé‡æ–°ç²å–ä¸¦å®šç¾© editorWidth å’Œ editorHeight
    const editorWidth = window.editor.offsetWidth;
    const editorHeight = window.editor.offsetHeight;
    
    const targets = window.gameContentContainer.querySelectorAll('.draggable-image');
    
    targets.forEach((item, index) => {
        if (!item.id) {
            item.id = `default-item-${index}`;
        }
        
        // ä½¿ç”¨æ–°çš„å‡½æ•¸å°‡æ¯å€‹ç›®æ¨™ç§»å‹•åˆ°éš¨æ©Ÿä½ç½®
        teleportTargetToNewPosition(item); 
        
        item.style.backgroundColor = '#fca5a5';
    });
    
    // æ¸¸æ¨™é‚è¼¯ä¹Ÿéœ€è¦ç”¨åˆ°é€™äº›å°ºå¯¸
    if (window.cursorPlayer) {
        const playerW = window.cursorPlayer.offsetWidth;
        const playerH = window.cursorPlayer.offsetHeight;
        window.cursorPlayer.style.left = `${(editorWidth / 2) - (playerW / 2)}px`;
        window.cursorPlayer.style.top = `${(editorHeight / 2) - (playerH / 2)}px`;
    }
    
    window.score = 0;
    if (window.scoreDisplay) window.scoreDisplay.textContent = window.score;
}


// --- Helper: é‡è¨­å…ƒç´ ä½ç½®ä¸¦è¨ˆç®—æ–°é€Ÿåº¦ (ä¿®æ­£: ç’°ç¹æ™‚åŠ å…¥éš¨æ©Ÿä½ç½®åç§») ---
window.resetDraggablePosition = function(item, animationType) {
    if (!window.editor) return { vx: 0, vy: 0 };
    const editorWidth = window.editor.offsetWidth;
    const editorHeight = window.editor.offsetHeight;
    let x = item.offsetLeft;
    let y = item.offsetTop;
    const w = item.offsetWidth;
    const h = item.offsetHeight;
    let state = window.draggableStates.get(item) || { vx: 0, vy: 0 };
    let needsNewVelocity = false;
    
    const PADDING = 10;
    const maxX = editorWidth - w - PADDING;
    const maxY = editorHeight - h - PADDING;
    
    // --- ç’°ç¹é‚è¼¯ (Wrapping) ---
    let wasWrapped = false;

    // æª¢æŸ¥ X è»¸ç’°ç¹
    if (x + w < 0) { 
        x = editorWidth; 
        wasWrapped = true; 
    } else if (x > editorWidth) { 
        x = -w; 
        wasWrapped = true; 
    }
    
    // æª¢æŸ¥ Y è»¸ç’°ç¹
    if (y + h < 0) { 
        y = editorHeight; 
        wasWrapped = true; 
    } else if (y > editorHeight) { 
        y = -h; 
        wasWrapped = true; 
    }
    
    // ğŸš¨ é—œéµä¿®æ­£ï¼šç•¶ç™¼ç”Ÿç’°ç¹æ™‚ (wasWrapped)ï¼Œéš¨æ©Ÿé‡å®šä½å…¶éé‹å‹•è»¸ç·š
    if (wasWrapped) {
        needsNewVelocity = true; // å³ä½¿é€Ÿåº¦ç›¸åŒï¼Œä¹Ÿéœ€è¦é‡æ–°è¨ˆç®—ä½ç½®

        switch (animationType) {
            case 'flow-left': // æ°´å¹³å‘å·¦æµå‹• (X è»¸ç§»å‹•)
            case 'horizontal': // æ°´å¹³ç’°ç¹ (X è»¸ç§»å‹•)
                // éš¨æ©Ÿé‡è¨­ Y è»¸ä½ç½®ï¼Œä»¥åˆ†æ•£ç›®æ¨™
                y = Math.random() * (maxY - PADDING) + PADDING;
                break;
            case 'fall-down': // å‚ç›´å‘ä¸‹æµå‹• (Y è»¸ç§»å‹•)
            case 'vertical': // å‚ç›´ç’°ç¹ (Y è»¸ç§»å‹•)
                // éš¨æ©Ÿé‡è¨­ X è»¸ä½ç½®ï¼Œä»¥åˆ†æ•£ç›®æ¨™
                x = Math.random() * (maxX - PADDING) + PADDING;
                break;
            case 'random': // éš¨æ©Ÿæ¨¡å¼ (X, Y éƒ½ç§»å‹•)
            default:
                // å¦‚æœæ˜¯éš¨æ©Ÿç§»å‹•æ¨¡å¼ï¼Œç’°ç¹å¾Œä¹Ÿé‡æ–°ç”Ÿæˆæ•´å€‹é€Ÿåº¦æ–¹å‘ï¼Œç¢ºä¿ä½ç½®åˆ†æ•£
                if (wasWrapped) {
                   teleportTargetToNewPosition(item);
                   return window.draggableStates.get(item); // è®“ teleport å‡½æ•¸è™•ç†ä½ç½®å’Œé€Ÿåº¦
                }
                break;
        }
    }

    // é‡æ–°æ‡‰ç”¨è¨ˆç®—éçš„ä½ç½® (å¦‚æœæ˜¯éš¨æ©Ÿæ¨¡å¼ï¼ŒteleportTargetToNewPosition å·²ç¶“è¨­ç½®äº†)
    if (animationType !== 'random' || !wasWrapped) {
         item.style.left = `${x}px`;
         item.style.top = `${y}px`;
    }

    // é€Ÿåº¦é‚è¼¯ (ç•¶ç’°ç¹ç™¼ç”Ÿæˆ–é€Ÿåº¦ç‚ºé›¶æ™‚é‡æ–°è¨ˆç®—)
    if (needsNewVelocity || (state.vx === 0 && state.vy === 0)) {
        let angle;
        switch (animationType) {
            // ... (é€Ÿåº¦è¨ˆç®—é‚è¼¯ä¿æŒä¸è®Šï¼Œç•¥)
            case 'flow-left': state.vx = -window.DRAG_SPEED; state.vy = 0; break;
            case 'fall-down': state.vx = 0; state.vy = window.DRAG_SPEED; break;
            case 'vertical': angle = Math.random() < 0.5 ? Math.PI / 2 : 3 * Math.PI / 2; state.vx = 0; state.vy = Math.sin(angle) * window.DRAG_SPEED; break;
            case 'horizontal': angle = Math.random() < 0.5 ? 0 : Math.PI; state.vx = Math.cos(angle) * window.DRAG_SPEED; state.vy = 0; break;
            case 'random': default: angle = Math.random() * 2 * Math.PI; state.vx = Math.cos(angle) * window.DRAG_SPEED; state.vy = Math.sin(angle) * window.DRAG_SPEED; break;
        }
    }
    
    window.draggableStates.set(item, state);
    return state;
}


// --- æ ¸å¿ƒå‹•ç•«å¾ªç’° (ç¢ºä¿éè¿´å‘¼å«) ---
window.animateAllRandomly = function(animationType) {
    if (!window.gameContentContainer) return;

    const targets = window.gameContentContainer.querySelectorAll('.draggable-image');
    if (targets.length === 0) {
        window.stopAnimation();
        return;
    }

    function step() {
        if (!window.isAnimationRunning) {
            cancelAnimationFrame(window.animationFrameId);
            window.animationFrameId = null;
            return;
        }

        targets.forEach(item => {
            const state = window.resetDraggablePosition(item, animationType);
            let currentX = item.offsetLeft + state.vx;
            let currentY = item.offsetTop + state.vy;
            item.style.left = `${currentX}px`;
            item.style.top = `${currentY}px`;
        });

        checkCollisionAndScore();
        // ç¢ºä¿é€™è£¡æœ‰éè¿´å‘¼å«ï¼Œè®“å‹•ç•«ç¹¼çºŒ
        window.animationFrameId = requestAnimationFrame(step); 
    }

    // åªæœ‰åœ¨å‹•ç•«å°šæœªå•Ÿå‹•æ™‚æ‰å•Ÿå‹•æ–°çš„å¾ªç’°
    if (!window.animationFrameId) { 
        window.animationFrameId = requestAnimationFrame(step);
    }
}

        // --- éŠæ¨™ç©å®¶ç§»å‹•è™•ç† (ä¿æŒä¸è®Š) ---
        function handlePlayerMove(e) {
            if (!window.cursorPlayer || !window.isAnimationRunning || !window.editor) return;

            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;

            const rect = window.editor.getBoundingClientRect();
            const playerW = window.cursorPlayer.offsetWidth;
            const playerH = window.cursorPlayer.offsetHeight;

            let newX = clientX - rect.left - playerW / 2;
            let newY = clientY - rect.top - playerH / 2;

            newX = Math.max(0, Math.min(newX, rect.width - playerW));
            newY = Math.max(0, Math.min(newY, rect.height - playerH));

            // æ ¹æ“šæ¨¡å¼é–å®šè»¸å‘ä¸¦è®Šè‰²
            if (['fall-down', 'vertical'].includes(window.currentAnimationType)) {
                newY = (rect.height / 2) - (playerH / 2);
                window.cursorPlayer.style.backgroundColor = '#9333ea';
            } else if (['flow-left', 'horizontal'].includes(window.currentAnimationType)) {
                newX = (rect.width / 2) - (playerW / 2);
                window.cursorPlayer.style.backgroundColor = '#f59e0b';
            } else {
                window.cursorPlayer.style.backgroundColor = '#38bdf8';
            }

            window.cursorPlayer.style.left = `${newX}px`;
            window.cursorPlayer.style.top = `${newY}px`;
            
            if (e.type === 'touchmove') e.preventDefault();
        }

        // --- å‹•ç•«æ§åˆ¶å‡½æ•¸ (åœæ­¢) (ä¿æŒä¸è®Š) ---
        window.stopAnimation = function() {
            if (window.animationFrameId) {
                cancelAnimationFrame(window.animationFrameId);
                window.animationFrameId = null;
            }
            if (window.timerId) {
                clearTimeout(window.timerId);
                window.timerId = null;
            }
            window.isAnimationRunning = false;
            window.draggableStates.clear();
            window.currentTargetId = null;
            
            if (window.editor) {
                window.editor.classList.add('opacity-50');
                window.editor.style.cursor = 'auto';
                document.querySelectorAll('.draggable-image').forEach(item => item.style.border = '4px solid white');
            }
            
            const displayer = document.getElementById('displayer');
            if (displayer) displayer.innerHTML = `<span style="color: #9ca3af;">é»æ“Šé–‹å§‹éŠæˆ²!</span>`;
            console.log("Game stopped.");
        };

// --- å‹•ç•«æ§åˆ¶å‡½æ•¸ (å•Ÿå‹•) (ç¢ºä¿å‘¼å«äº† animateAllRandomly) ---
window.setAndStartAnimation = function(type) {
    window.stopAnimation();
    
    window.currentAnimationType = type;
    window.setSafeInitialPositions();
    
    document.querySelectorAll('.draggable-image').forEach(item => {
        // ç¢ºä¿ç‚ºæ¯å€‹ç›®æ¨™è¨­ç½®åˆå§‹é€Ÿåº¦ç‹€æ…‹
        window.resetDraggablePosition(item, type); 
    });

    window.isAnimationRunning = true;
    
    // ğŸš¨ é€™æ˜¯æœ€é—œéµçš„ä¸€è¡Œï¼Œå¿…é ˆç¢ºä¿å®ƒå­˜åœ¨ä¸”è¢«å‘¼å«
    window.animateAllRandomly(type); 
    
    window.selectNewTarget();

    if (window.editor) {
        window.editor.classList.remove('opacity-50');
        window.editor.style.cursor = 'none';
    }

    const DURATION_SECONDS = 60;
    window.timerId = setTimeout(() => {
        window.stopAnimation();
        // ... (çœç•¥ alertUser é‚è¼¯)
    }, DURATION_SECONDS * 1000);
    
    console.log(`Game set and started: ${type} mode.`);
};


        // --- åˆå§‹åŒ–å‡½æ•¸ ---
        window.initGame = function() {
            window.rebindElementsAndState();
            
            // è¼‰å…¥ localStorage æˆ–é è¨­å…§å®¹ï¼Œä¸¦åŸ·è¡Œ updateStage
            const targetDiv = document.getElementById('targetDiv');
            const receivedContent = localStorage.getItem('editorContentKey');
            
            if (receivedContent && targetDiv) {
                 targetDiv.innerHTML = receivedContent;
                 updateStage(); 
            } else {
                // å¦‚æœæ²’æœ‰å…§å®¹ï¼ŒåŠ å…¥é è¨­ç›®æ¨™
                const defaultContent = `
                    <div class="draggable-image" style="top: 10%; left: 10%;">A</div>
                    <div class="draggable-image" style="top: 80%; left: 80%;">B</div>
                `;
                if (targetDiv) targetDiv.innerHTML = defaultContent;
                updateStage(); 
            }

            window.setSafeInitialPositions();
            window.stopAnimation();
            
            // ç¶å®šç§»å‹•äº‹ä»¶
            document.removeEventListener('mousemove', handlePlayerMove);
            document.removeEventListener('touchmove', handlePlayerMove, { passive: false });
            document.addEventListener('mousemove', handlePlayerMove);
            document.addEventListener('touchmove', handlePlayerMove, { passive: false });
        }
        
        document.addEventListener('DOMContentLoaded', window.initGame);
    </script>
</head>
<body class="p-4" >
    <div id="targetDiv" onclick="this.style.display='none';updateStage();" >---</div>

    <div class="p-4 bg-white rounded-xl shadow-xl flex flex-wrap justify-center gap-4 max-w-4xl w-full">
        <h1 class="text-2xl font-extrabold text-gray-800 w-full text-center mb-2">åœ–åƒæ•æ‰éŠæˆ² (è‡ªå‹•è¨ˆæ™‚ 60 ç§’)</h1>

        <div class="w-full flex justify-between items-center mb-4 px-2">
            <div class="text-lg font-bold text-gray-700">
                åˆ†æ•¸: <span id="scoreDisplay" class="text-4xl text-pink-600 font-extrabold ml-2">0</span>
            </div>
            <div class="text-right">
                <label for="speedSlider" class="block text-sm font-medium text-gray-700">å‹•ç•«é€Ÿåº¦:</label>
                <span id="currentSpeedDisplay" class="font-extrabold text-indigo-700 text-lg">1.50</span>x
                <input type="range" id="speedSlider" min="0.5" max="5.0" step="0.1" value="1.5"
                       class="w-32 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>
        </div>

        <button id="startRandomBtn" onclick="window.setAndStartAnimation('random')" class="px-3 py-2 bg-indigo-500 text-white font-bold rounded-full hover:bg-indigo-600 transition duration-150 shadow-md transform hover:scale-105 flex-grow">
            ğŸŒ€ éš¨æ©Ÿæ¨¡å¼ (X/Y çš†å¯å‹•)
        </button>
        <button id="startFlowLeftBtn" onclick="window.setAndStartAnimation('flow-left')" class="px-3 py-2 bg-cyan-600 text-white font-bold rounded-full hover:bg-cyan-700 transition duration-150 shadow-md transform hover:scale-105 flex-grow">
            â¬…ï¸ é å·¦æµå‹• (ç©å®¶ X è»¸é–å®š)
        </button>
        <button id="startFallDownBtn" onclick="window.setAndStartAnimation('fall-down')" class="px-3 py-2 bg-fuchsia-600 text-white font-bold rounded-full hover:bg-fuchsia-700 transition duration-150 shadow-md transform hover:scale-105 flex-grow">
            â¬‡ï¸ å‚ç›´è½ä¸‹ (ç©å®¶ Y è»¸é–å®š)
        </button>
        <button id="startVerticalBtn" onclick="window.setAndStartAnimation('vertical')" class="px-3 py-2 bg-green-500 text-white font-bold rounded-full hover:bg-green-600 transition duration-150 shadow-md transform hover:scale-105 flex-grow">
            â†•ï¸ å‚ç›´ç’°ç¹ (ç©å®¶ Y è»¸é–å®š)
        </button>
        <button id="startHorizontalBtn" onclick="window.setAndStartAnimation('horizontal')" class="px-3 py-2 bg-yellow-500 text-gray-800 font-bold rounded-full hover:bg-yellow-600 transition duration-150 shadow-md transform hover:scale-105 flex-grow">
            â†”ï¸ æ°´å¹³ç’°ç¹ (ç©å®¶ X è»¸é–å®š)
        </button>
        <button id="stopAnimationBtn" onclick="window.stopAnimation()" class="px-3 py-2 bg-red-600 text-white font-bold rounded-full hover:bg-red-700 transition duration-150 shadow-md transform hover:scale-105 flex-grow">
            ğŸ›‘ åœæ­¢éŠæˆ²
        </button>
    </div>

    <div id="displayer">
        <span style="color: #9ca3af;">é»æ“Šé–‹å§‹éŠæˆ²!</span>
    </div>

    <div id="editor">
        <div id="cursor-player"></div>

        <div id="game-content-container">
        </div>
    </div>
</body>
</html>
